<div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 my-8">
  <h1 class="text-4xl font-bold text-gray-800 mb-6">Empresas mantenedoras</h1>

  <!-- Tabs -->
  <div class="mt-2 border-b border-gray-700">
    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
      <%= link_to "Empresas mantenedoras",
                  info_path(tab: "empresas"),
                  class: [
                    "whitespace-nowrap py-4 px-1 border-b-2 text-sm font-medium",
                    (@active_tab == "empresas" ?
                       "border-yellow-500 text-black" :
                       "border-transparent text-black hover:text-black hover:border-gray-300")
                  ].join(" ") %>
    </nav>
  </div>

  <% if @active_tab == "empresas" %>
    <div class="bg-gray-800 shadow overflow-hidden sm:rounded-md mt-4">
      <div class="bg-gray-900 py-6 px-8 shadow-lg rounded-lg text-center">
        <h2 class="text-2xl font-bold text-white">Empresas mantenedoras</h2>
        <p class="text-gray-400">Resumen de empresas mantenedoras e inspecciones asociadas</p>

        <%= link_to "Descargar Excel",
                    export_empresas_path(format: :xlsx),
                    class: "inline-flex items-center mt-4 px-4 py-2 border border-transparent text-base leading-6 font-medium rounded-md text-green-400 bg-yellow-700 hover:bg-yellow-800 hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out",
                    data: { turbo: false } %>
      </div>

      <div class="table-responsive mt-6">
        <table id="empresas-table" class="table-auto w-full text-white border-collapse">
          <thead class="bg-gray-800">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider hover:text-blue-700">
              <p class="hover:text-blue-700">RUT</p>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider hover:text-blue-700">
              <p class="hover:text-blue-700">Empresa mantenedora</p>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider hover:text-blue-700">
              <p class="hover:text-blue-700">Rol</p>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider hover:text-blue-700">
              <p class="hover:text-blue-700">Inspecciones</p>
            </th>
          </tr>
          </thead>
          <tbody class="bg-gray-700 divide-y divide-gray-600">
          <% @empresas.each do |e| %>
            <tr class="bg-gray-800 border-b border-gray-700">
              <td class="px-6 py-4 whitespace-normal break-words">
                <span class="text-white"><%= e[:em_rut] %></span>
              </td>
              <td class="px-6 py-4 whitespace-normal break-words">
                <span class="text-white"><%= e[:empresa_mantenedora] %></span>
              </td>
              <td class="px-6 py-4 whitespace-normal break-words">
                <span class="text-white"><%= e[:em_rol] %></span>
              </td>

              <td class="px-6 py-4 whitespace-normal break-words">
                <div style="word-break: break-all;">
                  <%=
                      e[:inspections_map]
                      .sort_by { |number, _| number.to_i }
                      .map { |number, id|
                        link_to number,
                                inspection_path(id),
                                class: "text-blue-400 hover:text-blue-600",
                                data: { turbo_frame: "_top" }
                      }
                      .join(" / ")
                      .html_safe
                  %>
                </div>
              </td>
            </tr>
          <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>
</div>

<script>
    (function () {
        // ---- destruye la tabla antes de que Turbo la guarde en caché ----
        document.addEventListener("turbo:before-cache", () => {
            const tableEl = document.getElementById("empresas-table");
            if (tableEl && tableEl._dataTableInstance) {
                tableEl._dataTableInstance.destroy();
                delete tableEl._dataTableInstance;
            }
        });

        // ---- crea la tabla al cargar la página o un frame ----
        function initEmpresasTable() {
            const tableEl = document.getElementById("empresas-table");
            if (
              tableEl &&
              !tableEl._dataTableInstance &&
              typeof simpleDatatables !== "undefined" &&
              simpleDatatables.DataTable
            ) {
                const dataTable = new simpleDatatables.DataTable(tableEl, {
                    labels: {
                        placeholder: "Buscar...",
                        perPage: "registros por pág.",
                        noRows: "No hay datos para mostrar",
                        noResults: "No hay resultados que coincidan con tu búsqueda",
                        info: "Mostrando {start} a {end} de {rows} entradas"
                    },
                    tableRender: (_data, table, type) => {
                        if (type === "print") return table;

                        table.childNodes[0].childNodes.forEach((row) => {
                            if (!row.attributes) row.attributes = {};
                            row.attributes.class =
                              (row.attributes.class || "") + " bg-gray-800 text-white";

                            row.childNodes.forEach((th) => {
                                if (!th.attributes) th.attributes = {};
                                th.attributes.class =
                                  (th.attributes.class || "") + " bg-gray-800 text-white";
                            });
                        });

                        const tHead = table.childNodes[0];
                        const firstRow = tHead.childNodes[0];
                        const filterHeaders = {
                            nodeName: "TR",
                            attributes: {
                                class: "search-filtering-row bg-gray-800 text-white"
                            },
                            childNodes: firstRow.childNodes.map((_th, index) => ({
                                nodeName: "TH",
                                attributes: { style: "padding-top: 1rem;" },
                                childNodes: [
                                    {
                                        nodeName: "INPUT",
                                        attributes: {
                                            class:
                                              "datatable-input text-white placeholder-gray-400 bg-gray-700 border-gray-600 w-full",
                                            type: "search",
                                            "data-columns": "[" + index + "]",
                                            placeholder: "Filtrar"
                                        }
                                    }
                                ]
                            }))
                        };
                        tHead.childNodes.push(filterHeaders);

                        return table;
                    }
                });

                tableEl._dataTableInstance = dataTable;
            }
        }

        document.addEventListener("turbo:load", initEmpresasTable);
        document.addEventListener("turbo:frame-load", initEmpresasTable);
    })();
</script>

<style>
    .dataTable-table tbody td {
        color: #fff !important;
    }

    .datatable-ascending,
    .datatable-descending {
        background-color: #539DED !important;
        color: #fff !important;
    }

    #empresas-table thead th button.datatable-sorter {
        background: transparent !important;
        border: none !important;
        color: #fff !important;
    }

    #empresas-table thead th button.datatable-sorter:hover {
        background: transparent !important;
        color: #1d4ed8 !important;
    }

    #empresas-table thead th button.datatable-sorter:hover::before,
    #empresas-table thead th button.datatable-sorter:hover::after {
        background-color: transparent !important;
        color: #1d4ed8 !important;
    }

    #empresas-table thead th button.datatable-sorter:hover p.hover\:text-blue-700 {
        color: #1d4ed8 !important;
    }

    #empresas-table .datatable-selector {
        background-color: #f2f2f2 !important;
        color: #000 !important;
        border: 1px solid #ccc !important;
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
    }

    #empresas-table .datatable-input {
        background-color: #f2f2f2 !important;
        color: #000 !important;
        border: 1px solid #ccc !important;
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
    }

    #empresas-table .datatable-input::placeholder {
        color: #888;
    }
</style>
